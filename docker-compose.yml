services:
  db:
    image: postgres:16
    environment:
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=app
      - POSTGRES_DB=app
    volumes:
      - ./db/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
  auth:
    build:
      context: .
      dockerfile: Dockerfile.node
    environment:
      - PORT=3501
      - JWT_SECRET=dev-secret-change-me
      - DATABASE_URL=postgres://app:app@db:5432/app
      - PROFILE_URL=http://profile:3502
    command: ["node", "services/auth/dist/index.js"]
    ports:
      - "3501:3501"
    depends_on: [db]
  profile:
    build:
      context: .
      dockerfile: Dockerfile.node
    environment:
      - PORT=3502
      - JWT_SECRET=dev-secret-change-me
      - DATABASE_URL=postgres://app:app@db:5432/app
    command: ["node", "services/profile/dist/index.js"]
    ports:
      - "3502:3502"
    depends_on: [auth]
  inventory:
    build:
      context: .
      dockerfile: Dockerfile.node
    environment:
      - PORT=3504
      - JWT_SECRET=dev-secret-change-me
      - DATABASE_URL=postgres://app:app@db:5432/app
    command: ["node", "services/inventory/dist/index.js"]
    ports:
      - "3504:3504"
  product-order:
    build:
      context: .
      dockerfile: Dockerfile.node
    environment:
      - PORT=3505
      - JWT_SECRET=dev-secret-change-me
      - DATABASE_URL=postgres://app:app@db:5432/app
      - INVENTORY_URL=http://inventory:3504
      - PAYMENTS_URL=http://payments:3506
      - SHIPPING_URL=http://shipping:3507
      - NOTIFY_URL=http://notifications:3508
    command: ["node", "services/orders/dist/index.js"]
    ports:
      - "3505:3505"
    depends_on: [inventory, payments, notifications]
  payments:
    build:
      context: .
      dockerfile: Dockerfile.node
    environment:
      - PORT=3506
      - DATABASE_URL=postgres://app:app@db:5432/app
    command: ["node", "services/payments/dist/index.js"]
    ports:
      - "3506:3506"
  shipping:
    build:
      context: .
      dockerfile: Dockerfile.node
    environment:
      - PORT=3507
      - DATABASE_URL=postgres://app:app@db:5432/app
      - ORDERS_URL=http://product-order:3505
      - NOTIFY_URL=http://notifications:3508
    command: ["node", "services/shipping/dist/index.js"]
    ports:
      - "3507:3507"
    depends_on: [notifications, db]
  notifications:
    build:
      context: .
      dockerfile: Dockerfile.node
    environment:
      - PORT=3508
      - DATABASE_URL=postgres://app:app@db:5432/app
    command: ["node", "services/notifications/dist/index.js"]
    ports:
      - "3508:3508"
  images:
    build:
      context: .
      dockerfile: Dockerfile.node
    environment:
      - PORT=3509
    command: ["node", "services/images/dist/index.js"]
    ports:
      - "3509:3509"
    volumes:
      - ./images-storage:/app/images-storage
  search:
    build:
      context: .
      dockerfile: Dockerfile.node
    environment:
      - PORT=3510
      - DATABASE_URL=postgres://app:app@db:5432/app
    command: ["node", "services/search/dist/index.js"]
    ports:
      - "3510:3510"
    depends_on: [db]
  gateway:
    build:
      context: .
      dockerfile: Dockerfile.node
    environment:
      - PORT=3500
      - AUTH_URL=http://auth:3501
      - PROFILE_URL=http://profile:3502
      - PRODUCT_ORDER_URL=http://product-order:3505
      - INVENTORY_URL=http://inventory:3504
      - PAYMENTS_URL=http://payments:3506
      - SHIPPING_URL=http://shipping:3507
      - NOTIFY_URL=http://notifications:3508
      - IMAGES_URL=http://images:3509
      - SEARCH_URL=http://search:3510
    command: ["node", "services/gateway/dist/index.js"]
    ports:
      - "3500:3500"
    depends_on: [auth, profile, product-order, inventory, payments, shipping, notifications, images, search]

